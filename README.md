# XQBase Metric

A lightweight metric framework for aggregating, collecting and showing metric data.

For basic concepts of metric, see [Metric and Dashboard](http://www.slideshare.net/auntyellow/metric-and-dashboard) in SlideShare, or download [here](https://github.com/xqbase/metric/raw/master/doc/Metric%20and%20Dashboard.ppt).

## How to use Metric in Java codes?

Import the metric-client library as a maven dependency:

```xml
<dependency>
	<groupId>com.xqbase</groupId>
	<artifactId>xqbase-metric-client</artifactId>
	<version>0.2.13</version>
</dependency>
```

For a webapp project, add a filter into web.xml:

```xml
<filter>
	<filter-name>MetricFilter</filter-name>
	<filter-class>com.xqbase.metric.client.MetricFilter</filter-class>
	<init-param>
		<param-name>addresses</param-name>
		<param-value>${metric.collectors}</param-value>
	</init-param>
	<init-param>
		<param-name>prefix</param-name>
		<param-value>${metric.prefix}</param-value>
	</init-param>
	<init-param> <!-- this parameter is optional -->
		<param-name>tags</param-name>
		<param-value>${metric.tags}</param-value>
	</init-param>
</filter>
<filter-mapping>
	<filter-name>MetricFilter</filter-name>
	<url-pattern>/*</url-pattern>
</filter-mapping>
```

For a spring boot project, use `@Configuration` instead of web.xml:

```java
@Configuration
public class FilterConfig {
    @Bean
    public FilterRegistrationBean<MetricFilter> metricFilterRegistrationBean() {
        FilterRegistrationBean<MetricFilter> bean = new FilterRegistrationBean<>();
        MetricFilter filter = new MetricFilter();
        bean.setFilter(filter);
        bean.addUrlPatterns("/*");
        bean.addInitParameter("addresses", ${metric.collectors});
        bean.addInitParameter("prefix", ${metric.prefix});
        bean.addInitParameter("tags", ${metric.tags}); // this line is optional
        return bean;
    }
}
```

For a standalone application, use the following codes:

```java
// Start aggregating metrics
MetricClient.startup(collectors);
...
// Log an event
Metric.put(metricName, metricValue, tagName1, tagValue1, tagName2, tagValue2, ...);
...
// Stop aggregating metrics
MetricClient.shutdown();
```

## System Metrics

If `MetricFilter` or `ManagementMonitor` used, the following metrics are automatically generated:

CPU Usage：${metric.prefix}.server.cpu
GC Elapses：${metric.prefix}.server.gc
Memory Usage：${metric.prefix}.server.memory.mb
Memory Usage in Percentage：${metric.prefix}.server.memory.percent
Memory Pool Usage：${metric.prefix}.server.memory_pool.mb
Memory Pool Usage in Percentage：${metric.prefix}.server.memory_pool.percent
Threads：${metric.prefix}.server.threads
Web Request Concurrency：${metric.prefix}.webapp.connections (only work with `MetricFilter`)
Web Request Elapses：${metric.prefix}.webapp.request_time (only work with `MetricFilter`)
Other metrics can be generated by `Metric.put()` method.

See [P6Factory.java](https://github.com/xqbase/metric/blob/master/collector-sql/src/main/java/com/xqbase/metric/util/P6Factory.java) as an example to get metrics of SQL elapses and affected rows.

## How to deploy a Metric server?

- Install MongoDB
- Deploy Metric Collector
- Deploy and Configure Dashboard
